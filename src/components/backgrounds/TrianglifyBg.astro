---
/* Trianglify background loaded from CDN to avoid lockfile issues */
---

<style>
  .tri-bg-wrap { position: fixed; inset: 0; z-index: -50; pointer-events: none; }
  .tri-bg-wrap canvas { width: 100%; height: 100%; display: block; }
</style>

<div class="tri-bg-wrap">
  <canvas id="tri-bg"></canvas>
</div>

<script>
  if (typeof window !== 'undefined') {
    (async () => {
      // ESM build on jsDelivr (works well in browsers)
      const mod = await import('https://cdn.jsdelivr.net/npm/trianglify@4.1.1/dist/trianglify.esm.js');
      const trianglify = mod.default || mod;

      const canvas = document.getElementById('tri-bg');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      function sizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(window.innerWidth * dpr);
        canvas.height = Math.floor(window.innerHeight * dpr);
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      let hue = 205;
      let raf;

      function palette() {
        return Array.from({ length: 6 }, (_, i) => `hsl(${(hue + i * 5) % 360} 45% ${92 - i * 8}%)`);
      }

      function render() {
        const width = window.innerWidth;
        const height = window.innerHeight;

        const pattern = trianglify({
          width,
          height,
          cellSize: Math.max(80, Math.min(140, Math.floor(width / 12))),
          variance: 0.55,
          xColors: palette(),
          yColors: 'match',
          fill: true,
          strokeOpacity: 0.08,
          strokeWidth: 1,
        });

        pattern.toCanvas(canvas);
      }

      function animate() { hue = (hue + 0.02) % 360; render(); raf = requestAnimationFrame(animate); }
      function onResize() { sizeCanvas(); render(); }

      sizeCanvas();
      render();
      raf = requestAnimationFrame(animate);
      window.addEventListener('resize', onResize);

      addEventListener('astro:before-preload', () => {
        cancelAnimationFrame(raf);
        window.removeEventListener('resize', onResize);
      });
    })();
  }
</script>

